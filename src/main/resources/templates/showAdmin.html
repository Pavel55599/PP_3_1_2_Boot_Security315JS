<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">
<div class="container mt-4">
    <!-- Навбар -->
    <nav class="navbar navbar-dark bg-dark mb-3">
        <div class="container-fluid">
            <a class="navbar-brand" href="#" sec:authorize="isAuthenticated()">
                <span class="badge bg-primary me-2" th:text="${#authentication.principal.username}"></span>
                with roles:
                <span th:each="role : ${#authentication.principal.authorities}"
                      class="badge bg-info me-1"
                      th:text="${role.authority}"></span>
            </a>
            <div class="d-flex">
                <a sec:authorize="isAuthenticated()" th:href="@{/logout}" class="nav-link text-light-emphasis">
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Основной контент -->
    <div class="row">
        <!-- Левая панель -->
        <div class="col-md-3">
            <div class="nav flex-column nav-pills" role="tablist" aria-orientation="vertical">
                <a th:href="@{/admin}" class="nav-link active" id="adminPanelLink">Admin Panel</a>
                <a th:href="@{/user}" class="nav-link" sec:authorize="hasRole('USER')">User Panel</a>
            </div>
        </div>

        <!-- Правая панель -->
        <div class="col-md-9">
            <div class="tab-content">
                <div class="tab-pane fade show active">
                    <h1 class="display-6">ADMIN PANEL</h1>

                    <!-- Вкладки -->
                    <ul class="nav nav-tabs mb-0" style="z-index: 1; position: relative;">
                        <li class="nav-item">
                            <a th:href="@{/admin}" class="nav-link" id="usersTableTab">Users Table</a>
                        </li>
                        <li class="nav-item">
                            <a th:href="@{/admin/new}" class="nav-link" id="newUserTab">New User</a>
                        </li>
                    </ul>

                    <!-- Карточка таблицы пользователей -->
                    <div class="card rounded-top-0 border-top-0 mb-4" id="usersTableCard"
                         style="position: relative; top: -1px;">
                        <div class="card-header bg-light text-dark border-bottom text-start">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">ALL USERS</h5>
                                <button id="refreshBtn" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="loadingIndicator" class="text-center p-4">
                                <div class="loading-spinner"></div>
                                Loading users...
                            </div>
                            <div id="errorAlert" class="alert alert-danger m-3 d-none" role="alert"></div>
                            <table class="table table-striped table-hover mb-0 d-none" id="usersTable">
                                <thead>
                                <tr>
                                    <th class="text-center">ID</th>
                                    <th class="text-center">Username</th>
                                    <th class="text-center">Last Name</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">Roles</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                <!-- Users will be inserted here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>


                    <div class="card rounded-top-0 border-top-0 mb-4 d-none" id="newUserCard"
                         style="position: relative; top: -1px;">
                        <div class="card-header bg-light text-dark border-bottom text-start">
                            <h5 class="mb-0">CREATE NEW USER</h5>
                        </div>
                        <div class="card-body">
                            <div id="newUserErrorAlert" class="alert alert-danger d-none" role="alert"></div>
                            <div id="newUserSuccessAlert" class="alert alert-success d-none" role="alert">
                                User created successfully! Redirecting to admin panel...
                            </div>

                            <form id="createUserForm">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                                <!-- Все элементы формы теперь в одном столбце -->
                                <div class="row justify-content-center">
                                    <!-- Username -->
                                    <div class="col-12 col-md-8 col-lg-6">
                                        <div class="mb-3">
                                            <label for="username" class="form-label">Username:</label>
                                            <input type="text" class="form-control" id="username" required>
                                        </div>
                                    </div>

                                    <!-- Last Name -->
                                    <div class="col-12 col-md-8 col-lg-6">
                                        <div class="mb-3">
                                            <label for="lastName" class="form-label">Last Name:</label>
                                            <input type="text" class="form-control" id="lastName" required>
                                        </div>
                                    </div>

                                    <!-- Password -->
                                    <div class="col-12 col-md-8 col-lg-6">
                                        <div class="mb-3">
                                            <label for="password" class="form-label">Password:</label>
                                            <input type="password" class="form-control" id="password" required>
                                        </div>
                                    </div>

                                    <!-- Roles -->
                                    <div class="col-12 col-md-8 col-lg-6">
                                        <div class="mb-4">
                                            <label class="form-label mb-3">Roles:</label>
                                            <div id="rolesContainer" class="d-flex flex-wrap gap-2">
                                                <div class="spinner-border spinner-border-sm" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Enabled Switch -->
                                    <div class="col-12 col-md-8 col-lg-6">
                                        <div class="mb-3 form-check form-switch">
                                            <input class="form-check-input" type="checkbox" role="switch" id="enabled"
                                                   checked>
                                            <label class="form-check-label" for="enabled">Account Enabled</label>
                                        </div>
                                    </div>

                                    <!-- Buttons -->
                                    <div class="col-12 col-md-8 col-lg-6">
                                        <div class="d-flex justify-content-center gap-2 mt-4">
                                            <button type="button" id="cancelBtn" class="btn btn-secondary px-4">Cancel
                                            </button>
                                            <button type="submit" class="btn btn-primary px-4">Create User</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>


                    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header text-center justify-content-center">
                                    <h5 class="modal-title w-100" id="editUserModalLabel">Edit User</h5>
                                    <button type="button" class="btn-close position-absolute end-0 me-2"
                                            data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editUserForm" class="mx-auto" style="max-width: 400px;">
                                        <input type="hidden" id="editUserId">

                                        <div class="mb-3 text-center">
                                            <label for="editUsername" class="form-label">Username</label>
                                            <input type="text" class="form-control text-center" id="editUsername"
                                                   required>
                                        </div>
                                        <div class="mb-3 text-center">
                                            <label for="editLastName" class="form-label">Last Name</label>
                                            <input type="text" class="form-control text-center" id="editLastName"
                                                   required>
                                        </div>
                                        <div class="mb-3 text-center">
                                            <label for="editPassword" class="form-label">Password (leave blank to keep
                                                unchanged)</label>
                                            <input type="password" class="form-control text-center" id="editPassword">
                                        </div>
                                        <div class="mb-3 text-center">
                                            <label class="form-label">Roles</label>
                                            <div id="editRolesContainer"
                                                 class="d-flex flex-wrap gap-2 justify-content-center">
                                                <!-- Roles will be loaded here -->
                                            </div>
                                        </div>
                                        <div class="mb-3 form-check d-flex justify-content-center">
                                            <input type="checkbox" class="form-check-input me-2" id="editEnabled">
                                            <label class="form-check-label" for="editEnabled">Active</label>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer justify-content-center">
                                    <button type="button" class="btn btn-secondary mx-2" data-bs-dismiss="modal">
                                        Cancel
                                    </button>
                                    <button type="button" id="saveEditBtn" class="btn btn-primary mx-2">Save changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Модальное окно просмотра пользователя -->
                    <div class="modal fade" id="viewUserModal" tabindex="-1" aria-labelledby="viewUserModalLabel">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="viewUserModalLabel">User Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <strong>ID:</strong>
                                        <div id="viewUserId" class="mt-1"></div>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Status:</strong>
                                        <div id="viewUserStatus" class="mt-1"></div>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Username:</strong>
                                        <div id="viewUsername" class="mt-1"></div>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Last Name:</strong>
                                        <div id="viewLastName" class="mt-1"></div>
                                    </div>
                                    <div class="mb-3">
                                        <strong>Roles:</strong>
                                        <div id="viewUserRoles" class="mt-1"></div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Модальное окно подтверждения удаления -->
                    <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="deleteUserModalLabel">Delete User</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="deleteUserForm">
                                        <input type="hidden" id="deleteUserId">
                                        <div class="mb-3">
                                            <label class="form-label">ID:</label>
                                            <div id="deleteUserIdDisplay" class="form-control-plaintext"></div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Username:</label>
                                            <div id="deleteUsername" class="form-control-plaintext"></div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Last Name:</label>
                                            <div id="deleteUserLastName" class="form-control-plaintext"></div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Status:</label>
                                            <div id="deleteUserStatus" class="form-control-plaintext"></div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Roles:</label>
                                            <div id="deleteUserRoles" class="form-control-plaintext"></div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel
                                    </button>
                                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
                                        <span id="deleteButtonText">Delete User</span>
                                        <span id="deleteSpinner" class="spinner-border spinner-border-sm d-none"
                                              role="status"
                                              aria-hidden="true"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Контейнер для уведомлений -->
<div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // DOM elements
        const usersTableCard = document.getElementById('usersTableCard');
        const newUserCard = document.getElementById('newUserCard');
        const usersTableTab = document.getElementById('usersTableTab');
        const newUserTab = document.getElementById('newUserTab');
        const adminPanelLink = document.getElementById('adminPanelLink');
        const usersTable = document.getElementById('usersTable');
        const usersTableBody = document.getElementById('usersTableBody');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorAlert = document.getElementById('errorAlert');
        const refreshBtn = document.getElementById('refreshBtn');
        const createUserForm = document.getElementById('createUserForm');
        const newUserErrorAlert = document.getElementById('newUserErrorAlert');
        const newUserSuccessAlert = document.getElementById('newUserSuccessAlert');
        const rolesContainer = document.getElementById('rolesContainer');
        const cancelBtn = document.getElementById('cancelBtn');

        // Modal elements
        const editUserModal = new bootstrap.Modal(document.getElementById('editUserModal'));
        const editUserForm = document.getElementById('editUserForm');
        const editRolesContainer = document.getElementById('editRolesContainer');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const viewUserModal = new bootstrap.Modal(document.getElementById('viewUserModal'));
        const viewUserId = document.getElementById('viewUserId');
        const viewUsername = document.getElementById('viewUsername');
        const viewLastName = document.getElementById('viewLastName');
        const viewUserStatus = document.getElementById('viewUserStatus');
        const viewUserRoles = document.getElementById('viewUserRoles');
        const deleteUserModal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
        const deleteUserName = document.getElementById('deleteUserName');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        // State management
        let cachedRoles = null;
        let cachedUsers = null;
        let lastUsersUpdate = 0;
        let isInitialLoad = true;
        let currentView = window.location.pathname.endsWith('/new') ? 'newUser' : 'users';
        let refreshDebounceTimer = null;
        let currentDeleteUserId = null;

        // Initial setup
        setupEventListeners();
        determineInitialView();
        if (isInitialLoad) {
            loadInitialData();
            isInitialLoad = false;
        }

        function setupEventListeners() {
            // Navigation
            newUserTab.addEventListener('click', handleNewUserTabClick);
            usersTableTab.addEventListener('click', handleUsersTableTabClick);
            adminPanelLink.addEventListener('click', handleAdminPanelLinkClick);
            cancelBtn.addEventListener('click', handleCancelClick);
            window.addEventListener('popstate', handlePopState);

            // User actions
            refreshBtn.addEventListener('click', debounce(loadUsers, 300));
            createUserForm.addEventListener('submit', handleCreateUserSubmit);
            saveEditBtn.addEventListener('click', handleSaveEditClick);
            confirmDeleteBtn.addEventListener('click', handleConfirmDeleteClick);
        }

        function debounce(func, delay) {
            let timeout;
            return function () {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function determineInitialView() {
            const newView = window.location.pathname.endsWith('/new') ? 'newUser' : 'users';
            if (newView !== currentView) {
                currentView = newView;
                if (currentView === 'newUser') {
                    showNewUserForm();
                } else {
                    showUsersTable();
                }
            }
        }

        function loadInitialData() {
            loadUsers();
            loadRoles();
        }

        // View management functions
        function showUsersTable() {
            usersTableCard.classList.remove('d-none');
            newUserCard.classList.add('d-none');
            usersTableTab.classList.add('active');
            newUserTab.classList.remove('active');
        }

        function showNewUserForm() {
            usersTableCard.classList.add('d-none');
            newUserCard.classList.remove('d-none');
            usersTableTab.classList.remove('active');
            newUserTab.classList.add('active');
            createUserForm.reset();
            newUserErrorAlert.classList.add('d-none');
            newUserSuccessAlert.classList.add('d-none');
        }

        // Event handlers
        function handleNewUserTabClick(e) {
            e.preventDefault();
            if (currentView !== 'newUser') {
                showNewUserForm();
                currentView = 'newUser';
                window.history.pushState(null, '', '/admin/new');
            }
        }

        function handleUsersTableTabClick(e) {
            e.preventDefault();
            if (currentView !== 'users') {
                showUsersTable();
                currentView = 'users';
                window.history.pushState(null, '', '/admin');
            }
        }

        function handleAdminPanelLinkClick(e) {
            e.preventDefault();
            if (currentView !== 'users') {
                showUsersTable();
                currentView = 'users';
                window.history.pushState(null, '', '/admin');
            }
        }

        function handleCancelClick() {
            if (currentView !== 'users') {
                showUsersTable();
                currentView = 'users';
                window.history.pushState(null, '', '/admin');
            }
        }

        function handlePopState() {
            determineInitialView();
        }

        async function handleCreateUserSubmit(e) {
            e.preventDefault();
            await createUser();
        }

        async function handleSaveEditClick() {
            await updateUser();
        }

        async function handleConfirmDeleteClick() {
            if (!currentDeleteUserId) return;

            try {
                const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                const response = await fetch(`/api/admin/${currentDeleteUserId}`, {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete user');
                }

                deleteUserModal.hide();
                loadUsers(true); // Обновляем список пользователей
                showToast('User deleted successfully', 'success');

            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('Error deleting user: ' + error.message, 'danger');
            }
        }

        // Data loading functions
        async function loadUsers(forceRefresh = false) {
            const now = Date.now();
            const cacheExpired = now - lastUsersUpdate > 30000; // 30 seconds cache

            if (!forceRefresh && cachedUsers && !cacheExpired) {
                renderUsers(cachedUsers);
                return;
            }

            try {
                showLoading();

                const response = await fetch('/api/admin', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                cachedUsers = await response.json();
                lastUsersUpdate = Date.now();
                renderUsers(cachedUsers);
                hideLoading();

            } catch (error) {
                console.error('Error loading users:', error);
                showError(`Error loading users: ${error.message}`);
                hideLoading();
            }
        }

        function showLoading() {
            loadingIndicator.classList.remove('d-none');
            usersTable.classList.add('d-none');
            errorAlert.classList.add('d-none');
        }

        function hideLoading() {
            loadingIndicator.classList.add('d-none');
            usersTable.classList.remove('d-none');
        }

        function showError(message) {
            errorAlert.textContent = message;
            errorAlert.classList.remove('d-none');
        }

        function renderUsers(users) {
            usersTableBody.innerHTML = '';
            users.forEach(user => createUserRow(user));
        }

        function createUserRow(user) {
            const row = document.createElement('tr');

            // ID
            row.appendChild(createTableCell(user.id, 'text-center'));

            // Username
            row.appendChild(createTableCell(user.username, 'text-center'));

            // Last Name
            row.appendChild(createTableCell(user.lastName, 'text-center'));

            // Status
            row.appendChild(createStatusCell(user.enabled));

            // Roles
            row.appendChild(createRolesCell(user.authorities));

            // Actions
            row.appendChild(createActionsCell(user.id));

            usersTableBody.appendChild(row);
        }

        function createTableCell(content, className = '') {
            const cell = document.createElement('td');
            cell.textContent = content;
            if (className) cell.className = className;
            return cell;
        }

        function createStatusCell(enabled) {
            const cell = document.createElement('td');
            cell.className = 'text-center';

            const statusBadge = document.createElement('span');
            statusBadge.className = enabled ? 'badge bg-success' : 'badge bg-secondary';
            statusBadge.textContent = enabled ? 'Active' : 'Inactive';
            cell.appendChild(statusBadge);

            return cell;
        }

        function createRolesCell(authorities) {
            const cell = document.createElement('td');
            cell.className = 'text-center';

            if (authorities && authorities.length > 0) {
                authorities.forEach(role => {
                    const roleBadge = document.createElement('span');
                    roleBadge.className = 'badge bg-info me-1';
                    roleBadge.textContent = role.name;
                    cell.appendChild(roleBadge);
                });
            }

            return cell;
        }

        function createActionsCell(userId) {
            const cell = document.createElement('td');
            cell.className = 'text-center';

            const actionsGroup = document.createElement('div');
            actionsGroup.className = 'btn-group';
            actionsGroup.setAttribute('role', 'group');

            // View button
            const viewBtn = createActionButton(
                '#',
                'btn-outline-primary',
                '<i class="bi bi-eye"></i> View'
            );
            viewBtn.addEventListener('click', () => openViewModal(userId));
            actionsGroup.appendChild(viewBtn);


            // Edit button
            const editBtn = createActionButton(
                '#',
                'btn-outline-warning',
                '<i class="bi bi-pencil"></i> Edit'
            );
            editBtn.addEventListener('click', () => openEditModal(userId));
            actionsGroup.appendChild(editBtn);


            // Delete button
            const deleteBtn = createActionButton(
                '#',
                'btn-outline-danger',
                '<i class="bi bi-trash"></i> Delete'
            );
            deleteBtn.addEventListener('click', () => openDeleteModal(userId));
            actionsGroup.appendChild(deleteBtn);

            cell.appendChild(actionsGroup);
            return cell;
        }

        function createActionButton(href, btnClass, html) {
            const btn = document.createElement('a');
            btn.href = href;
            btn.className = `btn btn-sm ${btnClass}`;
            btn.innerHTML = html;
            return btn;
        }

        // Role management
        async function loadRoles() {
            if (cachedRoles) {
                renderRoles(rolesContainer, cachedRoles);
                return;
            }

            try {
                const response = await fetch('/api/admin/roles', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load roles');
                }

                cachedRoles = await response.json();
                renderRoles(rolesContainer, cachedRoles);

            } catch (error) {
                console.error('Error loading roles:', error);
                rolesContainer.innerHTML = `<div class="text-danger">Error loading roles: ${error.message}</div>`;
            }
        }

        function renderRoles(container, roles) {
            container.innerHTML = '';
            roles.forEach(role => {
                const checkboxId = `role-${role.id}`;
                const div = document.createElement('div');
                div.className = 'form-check';

                const input = document.createElement('input');
                input.className = 'form-check-input role-checkbox';
                input.type = 'checkbox';
                input.value = role.id;
                input.id = checkboxId;

                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = checkboxId;
                label.textContent = role.name;

                div.appendChild(input);
                div.appendChild(label);
                container.appendChild(div);
            });
        }


        // User CRUD operations
        async function createUser() {
            const csrfToken = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

            const user = {
                username: document.getElementById('username').value.trim(),
                lastName: document.getElementById('lastName').value.trim(),
                password: document.getElementById('password').value,
                enabled: document.getElementById('enabled').checked
            };

            const selectedRoles = Array.from(document.querySelectorAll('.role-checkbox:checked'))
                .map(checkbox => parseInt(checkbox.value));

            if (!user.password) {
                showNewUserError("Password cannot be empty!");
                return;
            }

            try {
                const url = new URL('/api/admin', window.location.origin);
                selectedRoles.forEach(roleId => {
                    url.searchParams.append('selectedRoles', roleId);
                });

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(user)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to create user');
                }

                newUserSuccessAlert.classList.remove('d-none');
                setTimeout(() => {
                    showUsersTable();
                    currentView = 'users';
                    window.history.pushState(null, '', '/admin');
                    loadUsers(true); // Force refresh after creation
                }, 2000);

            } catch (error) {
                showNewUserError(error.message);
            }
        }

        async function openViewModal(userId) {
            try {
                const response = await fetch(`/api/admin/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load user data');
                }

                const user = await response.json();

                // Заполняем модальное окно данными
                viewUserId.textContent = user.id;
                viewUsername.textContent = user.username;
                viewLastName.textContent = user.lastName;

                // Статус
                const statusBadge = document.createElement('span');
                statusBadge.className = user.enabled ? 'badge bg-success' : 'badge bg-secondary';
                statusBadge.textContent = user.enabled ? 'Active' : 'Inactive';
                viewUserStatus.innerHTML = '';
                viewUserStatus.appendChild(statusBadge);

                // Роли
                viewUserRoles.innerHTML = '';
                if (user.authorities && user.authorities.length > 0) {
                    user.authorities.forEach(role => {
                        const roleBadge = document.createElement('span');
                        roleBadge.className = 'badge bg-info me-1';
                        roleBadge.textContent = role.name;
                        viewUserRoles.appendChild(roleBadge);
                    });
                } else {
                    viewUserRoles.textContent = 'No roles assigned';
                }

                // Показываем модальное окно
                viewUserModal.show();

            } catch (error) {
                console.error('Error opening view modal:', error);
                alert('Error loading user data: ' + error.message);
            }
        }

        async function openEditModal(userId) {
            try {
                // Load user data
                const userResponse = await fetch(`/api/admin/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!userResponse.ok) {
                    throw new Error('Failed to load user data');
                }

                const user = await userResponse.json();

                // Use cached roles if available
                if (!cachedRoles) {
                    await loadRoles();
                }

                // Populate form
                document.getElementById('editUserId').value = user.id;
                document.getElementById('editUsername').value = user.username;
                document.getElementById('editLastName').value = user.lastName;
                document.getElementById('editEnabled').checked = user.enabled;

                // Render roles with checkboxes
                renderEditRoles(cachedRoles, user.authorities);

                // Show modal
                editUserModal.show();

            } catch (error) {
                console.error('Error opening edit modal:', error);
                alert('Error loading user data: ' + error.message);
            }
        }

        function renderEditRoles(allRoles, userRoles) {
            editRolesContainer.innerHTML = '';

            allRoles.forEach(role => {
                const checkboxId = `editRole-${role.id}`;
                const isChecked = userRoles.some(userRole => userRole.id === role.id);

                const div = document.createElement('div');
                div.className = 'form-check';

                const input = document.createElement('input');
                input.className = 'form-check-input edit-role-checkbox';
                input.type = 'checkbox';
                input.value = role.id;
                input.id = checkboxId;
                input.checked = isChecked;

                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = checkboxId;
                label.textContent = role.name;

                div.appendChild(input);
                div.appendChild(label);
                editRolesContainer.appendChild(div);
            });
        }

        async function openDeleteModal(userId) {
            try {
                // Находим пользователя в кэше или загружаем данные
                let user = cachedUsers.find(u => u.id === userId);
                if (!user) {
                    const response = await fetch(`/api/admin/${userId}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to load user data');
                    }
                    user = await response.json();
                }

                // Заполняем модальное окно данными
                document.getElementById('deleteUserId').value = user.id;
                document.getElementById('deleteUserIdDisplay').textContent = user.id;
                document.getElementById('deleteUsername').textContent = user.username;
                document.getElementById('deleteUserLastName').textContent = user.lastName;

                // Статус
                const statusBadge = document.createElement('span');
                statusBadge.className = user.enabled ? 'badge bg-success' : 'badge bg-secondary';
                statusBadge.textContent = user.enabled ? 'Active' : 'Inactive';
                document.getElementById('deleteUserStatus').innerHTML = '';
                document.getElementById('deleteUserStatus').appendChild(statusBadge);

                // Роли
                document.getElementById('deleteUserRoles').innerHTML = '';
                if (user.authorities && user.authorities.length > 0) {
                    user.authorities.forEach(role => {
                        const roleBadge = document.createElement('span');
                        roleBadge.className = 'badge bg-info me-1';
                        roleBadge.textContent = role.name;
                        document.getElementById('deleteUserRoles').appendChild(roleBadge);
                    });
                } else {
                    document.getElementById('deleteUserRoles').textContent = 'No roles assigned';
                }

                // Устанавливаем текущий ID пользователя для удаления
                currentDeleteUserId = userId;

                // Показываем модальное окно
                const deleteModal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
                deleteModal.show();

            } catch (error) {
                console.error('Error opening delete modal:', error);
                showToast('Error loading user data: ' + error.message, 'danger');
            }
        }

        async function handleConfirmDeleteClick() {
            if (!currentDeleteUserId) return;

            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const btnText = document.getElementById('deleteButtonText');
            const spinner = document.getElementById('deleteSpinner');

            try {
                // Показываем спиннер и меняем текст кнопки
                confirmBtn.disabled = true;
                btnText.textContent = 'Deleting...';
                spinner.classList.remove('d-none');

                const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                const response = await fetch(`/api/admin/${currentDeleteUserId}`, {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete user');
                }

                // Скрываем модальное окно
                const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteUserModal'));
                deleteModal.hide();

                // Обновляем список пользователей
                loadUsers(true);
                showToast('User deleted successfully', 'success');

            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('Error deleting user: ' + error.message, 'danger');
            } finally {
                // Восстанавливаем состояние кнопки
                confirmBtn.disabled = false;
                btnText.textContent = 'Delete User';
                spinner.classList.add('d-none');
            }
        }


        async function handleConfirmDeleteClick() {
            if (!currentDeleteUserId) return;

            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const btnText = document.getElementById('deleteButtonText');
            const spinner = document.getElementById('deleteSpinner');

            try {
                // Показываем спиннер и меняем текст кнопки
                confirmBtn.disabled = true;
                btnText.textContent = 'Deleting...';
                spinner.classList.remove('d-none');

                const csrfToken = document.querySelector('meta[name="_csrf"]').content;
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

                const response = await fetch(`/api/admin/${currentDeleteUserId}`, {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to delete user');
                }

                // Скрываем модальное окно
                const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteUserModal'));
                deleteModal.hide();

                // Обновляем список пользователей
                loadUsers(true);
                showToast('User deleted successfully', 'success');

            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('Error deleting user: ' + error.message, 'danger');
            } finally {
                // Восстанавливаем состояние кнопки
                confirmBtn.disabled = false;
                btnText.textContent = 'Delete User';
                spinner.classList.add('d-none');
            }
        }


        async function updateUser() {
            const csrfToken = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

            const userId = document.getElementById('editUserId').value;
            const user = {
                username: document.getElementById('editUsername').value.trim(),
                lastName: document.getElementById('editLastName').value.trim(),
                password: document.getElementById('editPassword').value,
                enabled: document.getElementById('editEnabled').checked
            };

            const selectedRoles = Array.from(document.querySelectorAll('.edit-role-checkbox:checked'))
                .map(checkbox => parseInt(checkbox.value));

            try {
                const url = new URL(`/api/admin/${userId}`, window.location.origin);
                selectedRoles.forEach(roleId => {
                    url.searchParams.append('selectedRoles', roleId);
                });

                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(user)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to update user');
                }

                editUserModal.hide();
                loadUsers(true); // Force refresh after update
                showToast('User updated successfully', 'success');

            } catch (error) {
                console.error('Error updating user:', error);
                showToast('Error updating user: ' + error.message, 'danger');
            }
        }

        function showNewUserError(message) {
            newUserErrorAlert.textContent = message;
            newUserErrorAlert.classList.remove('d-none');
            newUserSuccessAlert.classList.add('d-none');
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0 show`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');

            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;

            toastContainer.appendChild(toast);

            // Автоматическое скрытие через 5 секунд
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 150);
            }, 5000);
        }
    });
</script>
</body>
</html>


















