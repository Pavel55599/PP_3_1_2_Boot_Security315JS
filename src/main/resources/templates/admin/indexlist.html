<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .badge-role {
            cursor: pointer;
            margin-right: 5px;
        }
        .action-buttons {
            white-space: nowrap;
        }
        .card-tab {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            border-top: none;
        }
    </style>
</head>
<body class="bg-light">
<div class="container mt-4">
    <!-- Навбар -->
    <nav class="navbar navbar-dark bg-dark mb-3">
        <div class="container-fluid">
            <a class="navbar-brand" id="userInfo">
                <span class="badge bg-primary me-2" id="usernameBadge"></span>
                with roles:
                <span id="userRoles"></span>
            </a>
            <div class="d-flex">
                <a href="/logout" class="nav-link text-light-emphasis">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Основной контент -->
    <div class="row">
        <!-- Левая панель -->
        <div class="col-md-3">
            <div class="nav flex-column nav-pills" role="tablist" aria-orientation="vertical">
                <a href="#" class="nav-link active" id="adminPanelLink">Admin Panel</a>
                <a href="#" class="nav-link" id="userPanelLink">User Panel</a>
            </div>
        </div>

        <!-- Правая панель -->
        <div class="col-md-9">
            <div class="tab-content">
                <div class="tab-pane fade show active">
                    <h1 class="display-6">ADMIN PANEL</h1>

                    <!-- Вкладки -->
                    <ul class="nav nav-tabs mb-0" style="z-index: 1; position: relative;">
                        <li class="nav-item">
                            <a href="#" class="nav-link active" id="usersTab">Users Table</a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link" id="newUserTab">New User</a>
                        </li>
                    </ul>

                    <!-- Карточка таблицы пользователей -->
                    <div class="card card-tab rounded-top-0 border-top-0 mb-4">
                        <div class="card-header bg-light text-dark border-bottom text-start">
                            <h5 class="mb-0">ALL USERS</h5>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-striped table-hover mb-0">
                                <thead>
                                <tr>
                                    <th class="text-center">ID</th>
                                    <th class="text-center">Username</th>
                                    <th class="text-center">Last Name</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">Roles</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                <!-- Данные будут загружаться через JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для создания/редактирования пользователя -->
<div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="userForm">
                <div class="modal-body">
                    <input type="hidden" id="userId">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username *</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="lastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="lastName">
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enabled" checked>
                        <label class="form-check-label" for="enabled">Active</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Roles</label>
                        <div id="rolesContainer" class="d-flex flex-wrap">
                            <!-- Роли будут загружены через JavaScript -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this user?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Конфигурация API

    const API_BASE = '/api/admin';
    let allRoles = [];
    let currentUserId = null;
    let userModal = new bootstrap.Modal(document.getElementById('userModal'));
    let confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        loadCurrentUser();
        loadRoles();
        loadUsers();
        setupEventListeners();
    });

    // Загрузка информации о текущем пользователе
    async function loadCurrentUser() {
        try {
            const response = await fetch('/api/user/current');
            if (response.ok) {
                const user = await response.json();
                document.getElementById('usernameBadge').textContent = user.username;
                document.getElementById('userRoles').innerHTML = user.roles.map(role =>
                    `<span class="badge bg-info me-1">${role.name}</span>`
                ).join('');
            }
        } catch (error) {
            console.error('Error loading current user:', error);
        }
    }

    // Загрузка всех пользователей
    async function loadUsers() {
        try {
            const response = await fetch(API_BASE);
            if (response.ok) {
                const users = await response.json();
                renderUsers(users);
            }
        } catch (error) {
            console.error('Error loading users:', error);
            alert('Failed to load users');
        }
    }

    // Отображение пользователей в таблице
    function renderUsers(users) {
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = '';

        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No users found</td></tr>';
            return;
        }

        users.forEach(user => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-center">${user.id}</td>
                <td class="text-center">${user.username}</td>
                <td class="text-center">${user.lastName || '-'}</td>
                <td class="text-center">
                    <span class="badge ${user.enabled ? 'bg-success' : 'bg-secondary'}">
                        ${user.enabled ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td class="text-center">
                    ${user.roles.map(role =>
                `<span class="badge bg-info me-1">${role.name}</span>`
            ).join('')}
                </td>
                <td class="text-center">
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-warning me-1" onclick="editUser(${user.id})">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="showDeleteModal(${user.id})">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Загрузка всех ролей
    async function loadRoles() {
        try {
            const response = await fetch(`${API_BASE}/roles`);
            if (response.ok) {
                allRoles = await response.json();
                renderRoles();
            }
        } catch (error) {
            console.error('Error loading roles:', error);
            alert('Failed to load roles');
        }
    }

    // Отображение ролей в модальном окне
    function renderRoles() {
        const container = document.getElementById('rolesContainer');
        container.innerHTML = '';

        allRoles.forEach(role => {
            const div = document.createElement('div');
            div.className = 'form-check form-check-inline me-3';
            div.innerHTML = `
                <input class="form-check-input" type="checkbox" id="role-${role.id}" value="${role.id}">
                <label class="form-check-label" for="role-${role.id}">${role.name}</label>
            `;
            container.appendChild(div);
        });
    }

    // Настройка обработчиков событий
    function setupEventListeners() {
        // Кнопка нового пользователя
        document.getElementById('newUserTab').addEventListener('click', showNewUserModal);

        // Форма пользователя
        document.getElementById('userForm').addEventListener('submit', handleFormSubmit);

        // Кнопка подтверждения удаления
        document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
    }

    // Показать модальное окно для нового пользователя
    function showNewUserModal() {
        currentUserId = null;
        document.getElementById('modalTitle').textContent = 'New User';
        document.getElementById('userForm').reset();
        clearRoleSelections();
        userModal.show();
    }

    // Очистить выбор ролей
    function clearRoleSelections() {
        document.querySelectorAll('#rolesContainer input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });
    }

    // Редактирование пользователя
    async function editUser(userId) {
        try {
            const response = await fetch(`${API_BASE}/${userId}`);
            if (response.ok) {
                const user = await response.json();

                currentUserId = user.id;
                document.getElementById('modalTitle').textContent = 'Edit User';
                document.getElementById('userId').value = user.id;
                document.getElementById('username').value = user.username;
                document.getElementById('lastName').value = user.lastName || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('enabled').checked = user.enabled;

                clearRoleSelections();
                user.roles.forEach(role => {
                    const checkbox = document.getElementById(`role-${role.id}`);
                    if (checkbox) checkbox.checked = true;
                });

                userModal.show();
            }
        } catch (error) {
            console.error('Error loading user:', error);
            alert('Failed to load user');
        }
    }

    // Обработка формы
    async function handleFormSubmit(e) {
        e.preventDefault();
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;

        try {
            const userData = {
                username: document.getElementById('username').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                enabled: document.getElementById('enabled').checked
            };

            const selectedRoles = Array.from(
                document.querySelectorAll('#rolesContainer input[type="checkbox"]:checked')
            ).map(checkbox => parseInt(checkbox.value));

            const url = currentUserId ? `${API_BASE}/${currentUserId}` : API_BASE;
            const method = currentUserId ? 'PUT' : 'POST';

            // Для PUT/POST с параметрами запроса и телом
            const urlWithParams = new URL(url, window.location.origin);
            selectedRoles.forEach(roleId => {
                urlWithParams.searchParams.append('selectedRoles', roleId);
            });

            const response = await fetch(urlWithParams, {
                method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            });

            if (response.ok) {
                userModal.hide();
                await loadUsers();
            } else {
                const error = await response.text();
                throw new Error(error || 'Request failed');
            }
        } catch (error) {
            console.error('Error saving user:', error);
            alert(`Error: ${error.message}`);
        } finally {
            saveBtn.disabled = false;
        }
    }

    // Показать модальное окно подтверждения удаления
    function showDeleteModal(userId) {
        currentUserId = userId;
        confirmModal.show();
    }

    // Подтверждение удаления
    async function confirmDelete() {
        const deleteBtn = document.getElementById('confirmDeleteBtn');
        deleteBtn.disabled = true;

        try {
            const response = await fetch(`${API_BASE}/${currentUserId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                confirmModal.hide();
                await loadUsers();
            } else {
                throw new Error('Failed to delete user');
            }
        } catch (error) {
            console.error('Error deleting user:', error);
            alert('Failed to delete user');
        } finally {
            deleteBtn.disabled = false;
        }
    }

    // Сделать функции глобальными для обработчиков в HTML
    window.editUser = editUser;
    window.showDeleteModal = showDeleteModal;
</script>
</body>
</html>




<!--<!DOCTYPE html>-->
<!--<html xmlns:th="http://www.thymeleaf.org"-->
<!--      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1">-->
<!--    <title>Admin Panel</title>-->
<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">-->
<!--    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">-->
<!--</head>-->
<!--<body class="bg-light">-->
<!--<div class="container mt-4">-->

<!--    &lt;!&ndash; Навбар &ndash;&gt;-->
<!--    <nav class="navbar navbar-dark bg-dark mb-3">-->
<!--        <div class="container-fluid">-->
<!--            <a class="navbar-brand" href="#" sec:authorize="isAuthenticated()">-->
<!--                <span class="badge bg-primary me-2" th:text="${#authentication.principal.username}"></span>-->
<!--                with roles:-->
<!--                <span th:each="role : ${#authentication.principal.authorities}"-->
<!--                      class="badge bg-info me-1"-->
<!--                      th:text="${role.authority}"></span>-->
<!--            </a>-->
<!--            <div class="d-flex">-->
<!--                <a sec:authorize="isAuthenticated()" th:href="@{/logout}" class="nav-link text-light-emphasis">-->
<!--                    Logout-->
<!--                </a>-->
<!--            </div>-->
<!--        </div>-->
<!--    </nav>-->

<!--    &lt;!&ndash; Основной контент &ndash;&gt;-->
<!--    <div class="row">-->
<!--        &lt;!&ndash; Левая панель &ndash;&gt;-->
<!--        <div class="col-md-3">-->
<!--            <div class="nav flex-column nav-pills" role="tablist" aria-orientation="vertical">-->
<!--                <a th:href="@{/admin}" class="nav-link active">Admin Panel</a>-->
<!--                <a th:href="@{/user}" class="nav-link" sec:authorize="hasRole('USER')">User Panel</a>-->
<!--            </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; Правая панель &ndash;&gt;-->
<!--        <div class="col-md-9">-->
<!--            <div class="tab-content">-->
<!--                <div class="tab-pane fade show active">-->
<!--                    <h1 class="display-6">ADMIN PANEL</h1>-->

<!--                    &lt;!&ndash; Вкладки &ndash;&gt;-->
<!--                    <ul class="nav nav-tabs mb-0" style="z-index: 1; position: relative;">-->
<!--                        <li class="nav-item">-->
<!--                            <a th:href="@{/admin}" class="nav-link active">Users Table</a>-->
<!--                        </li>-->
<!--                        <li class="nav-item">-->
<!--                            <a th:href="@{/admin/new}" class="nav-link">New User</a>-->
<!--                        </li>-->
<!--                    </ul>-->

<!--                    &lt;!&ndash; Карточка таблицы пользователей &ndash;&gt;-->
<!--                    <div class="card rounded-top-0 border-top-0 mb-4" style="position: relative; top: -1px;">-->
<!--                        <div class="card-header bg-light text-dark border-bottom text-start">-->
<!--                            <h5 class="mb-0">ALL USERS</h5>-->
<!--                        </div>-->
<!--                        <div class="card-body p-0">-->
<!--                            <table class="table table-striped table-hover mb-0">-->
<!--                                <thead>-->
<!--                                <tr>-->
<!--                                    <th class="text-center">ID</th>-->
<!--                                    <th class="text-center">Username</th>-->
<!--                                    <th class="text-center">Last Name</th>-->
<!--                                    <th class="text-center">Status</th>-->
<!--                                    <th class="text-center">Roles</th>-->
<!--                                    <th class="text-center">Actions</th>-->
<!--                                </tr>-->
<!--                                </thead>-->
<!--                                <tbody>-->
<!--                                <tr th:each="user : ${users}">-->
<!--                                    <td th:text="${user.id}" class="text-center"></td>-->
<!--                                    <td th:text="${user.username}" class="text-center"></td>-->
<!--                                    <td th:text="${user.lastName}" class="text-center"></td>-->
<!--                                    <td class="text-center">-->
<!--                                        <span th:if="${user.enabled}" class="badge bg-success">Active</span>-->
<!--                                        <span th:unless="${user.enabled}" class="badge bg-secondary">Inactive</span>-->
<!--                                    </td>-->
<!--                                    <td class="text-center">-->
<!--                                        <span th:each="role : ${user.roles}" class="badge bg-info me-1"-->
<!--                                              th:text="${role.name}"></span>-->
<!--                                    </td>-->
<!--                                    <td class="text-center">-->
<!--                                        <div class="btn-group" role="group">-->
<!--                                            <a th:href="@{/admin/show(id=${user.id})}"-->
<!--                                               class="btn btn-sm btn-outline-primary">-->
<!--                                                <i class="bi bi-eye"></i> View-->
<!--                                            </a>-->
<!--                                            <a th:href="@{/admin/edit(id=${user.id},modal=true)}"-->
<!--                                               class="btn btn-sm btn-outline-warning">-->
<!--                                                <i class="bi bi-pencil"></i> Edit-->
<!--                                            </a>-->
<!--                                            <a th:href="@{/admin/delete(id=${user.id},modal=true)}"-->
<!--                                               class="btn btn-sm btn-outline-danger">-->
<!--                                                <i class="bi bi-trash"></i> Delete-->
<!--                                            </a>-->
<!--                                        </div>-->
<!--                                    </td>-->
<!--                                </tr>-->
<!--                                </tbody>-->
<!--                            </table>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->


<!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>-->
<!--</body>-->
<!--</html>-->






